# 點數累積系統使用說明

## 功能概述

點數累積系統允許商家設定消費獎勵規則，顧客在消費時自動獲得點數。

## 商家端操作

### 設定點數規則

1. 進入「會員制度管理」頁面
2. 點擊「點數規則」標籤
3. 點擊「新增規則」按鈕
4. 填寫規則資訊：
   - **規則名稱**：例如「基本點數規則」、「週末雙倍點數」
   - **每消費1元可得點數**：
     - 輸入 `0.01` 表示每消費100元可得1點
     - 輸入 `0.02` 表示每消費50元可得1點
     - 輸入 `1` 表示每消費1元可得1點
   - **最低消費金額**（可選）：
     - 例如輸入 `100` 表示至少消費100元才能獲得點數
     - 不填表示無限制
5. 點擊「新增」完成設定

### 管理點數規則

- 每個店家可以有多個點數規則
- 只有「啟用」狀態的規則會生效
- 可以隨時刪除不需要的規則
- 系統會自動選擇第一個啟用的規則進行計算

## 顧客端操作

### 查看點數

1. 在店家頁面點擊「會員中心」
2. 查看該店家的會員資訊：
   - **可用點數**：可用於兌換商品的點數
   - **累計點數**：歷史累積的總點數（用於計算會員等級）

### 獲得點數

顧客在以下情況會自動獲得點數：
1. 登入帳號後下單
2. 店家已啟用會員功能（`enable_loyalty = True`）
3. 消費金額達到點數規則的最低門檻
4. 店家有設定活躍的點數規則

點數會在訂單建立時立即計算並加入會員帳戶。

## 技術說明

### 點數計算公式

```
獲得點數 = 消費金額 × 點數比例
```

例如：
- 規則：每消費1元得0.01點，最低消費100元
- 消費300元 → 獲得 300 × 0.01 = 3點 ✓
- 消費50元 → 不符合最低消費門檻 → 0點 ✗

### 資料庫模型

#### PointRule（點數規則）
- `store`：所屬店家
- `name`：規則名稱
- `points_per_currency`：每單位貨幣得幾點（DecimalField）
- `min_spend`：最低消費金額
- `active`：是否啟用

#### CustomerLoyaltyAccount（會員帳戶）
- `user`：用戶
- `store`：店家
- `available_points`：可用點數
- `total_points`：累計總點數
- `current_level`：當前會員等級

#### PointTransaction（點數交易記錄）
- `account`：會員帳戶
- `transaction_type`：交易類型（earn/redeem/adjust/expire）
- `points`：點數變動量
- `description`：描述
- `order`：關聯訂單（可選）

### API 端點

#### 商家端
- `GET /loyalty/merchant/point-rules/` - 查看點數規則列表
- `POST /loyalty/merchant/point-rules/` - 新增點數規則
- `DELETE /loyalty/merchant/point-rules/{id}/` - 刪除點數規則

#### 顧客端
- `GET /loyalty/customer/accounts/` - 查看所有會員帳戶
- `GET /loyalty/customer/accounts/{id}/` - 查看特定會員帳戶
- `GET /loyalty/customer/transactions/` - 查看點數交易記錄

## 測試方法

### 使用腳本創建點數規則

```bash
cd backend
python create_point_rule.py
```

按照提示輸入規則資訊即可。

### 測試點數累積流程

1. 確保店家已啟用會員功能
2. 使用腳本或前端創建點數規則
3. 登入顧客帳號
4. 在該店家下單
5. 檢查會員帳戶點數是否正確增加
6. 查看點數交易記錄確認計算詳情

## 常見問題

**Q: 為什麼我下單後沒有獲得點數？**

A: 請檢查：
- 是否已登入帳號？
- 店家是否已啟用會員功能？
- 店家是否有設定活躍的點數規則？
- 消費金額是否達到最低門檻？

**Q: 可以有多個點數規則嗎？**

A: 可以，但系統只會使用第一個啟用的規則進行計算。建議同時只啟用一個規則。

**Q: 點數比例應該設定多少？**

A: 常見設定：
- 高價商品：0.01（每100元得1點）
- 中價商品：0.05（每20元得1點）
- 低價商品：0.1（每10元得1點）
- 慷慨獎勵：1（每1元得1點）

**Q: 點數會過期嗎？**

A: 目前系統不會自動讓點數過期，但可以透過後台管理設定過期規則。

## 未來擴展

可以考慮增加的功能：
- 點數過期機制
- 不同商品類別有不同的點數倍率
- 特定時段點數加倍
- 會員等級影響點數獲得倍率
- 推薦好友獎勵點數
